<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rider Absconding Tracker â€” Search</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --accent-1: #00b4d8;
      --accent-2: #0077b6;
      --danger: #ef476f;
      --glass: rgba(255,255,255,0.06);
      --muted: rgba(255,255,255,0.7);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Poppins',sans-serif;
      background: linear-gradient(135deg,#0f1724,#102a43);
      color:#fff;
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:24px;
    }
    .wrap{
      width:100%;
      max-width:1100px;
      background:var(--glass);
      border-radius:14px;
      padding:20px;
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 30px rgba(2,6,23,0.6);
    }
    header{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:18px;
    }
    h1{font-size:20px;color:var(--accent-1);margin:0}
    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .search {
      padding:10px 12px;
      background:rgba(0,0,0,0.25);
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.06);
      color:var(--muted);
      min-width:220px;
    }
    .form-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit,minmax(200px,1fr));
      gap:12px;
      margin-bottom:12px;
    }
    input, select {
      padding:12px;
      border-radius:10px;
      border:none;
      background: rgba(255,255,255,0.06);
      color:#fff;
      font-size:14px;
      outline:none;
    }
    .btn {
      padding:10px 14px;
      border-radius:10px;
      font-weight:600;
      cursor:pointer;
      border:none;
    }
    .btn-primary { background: linear-gradient(135deg,var(--accent-1),var(--accent-2)); color:white;}
    .btn-danger  { background: linear-gradient(135deg,#ff7b90,#ef476f); color:white;}
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      background: rgba(0,0,0,0.12);
      border-radius:8px;
      overflow:hidden;
    }
    thead th{
      text-align:left;
      padding:12px;
      background: rgba(0,0,0,0.28);
      color: #aee1ff;
      font-size:13px;
      position: sticky;
      top:0;
      z-index:2;
    }
    tbody td{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,0.04);
      font-size:14px;
      color: #f1f7fb;
    }
    tbody tr:hover{ background: rgba(255,255,255,0.02); }
    .actions { display:flex; gap:8px; }
    .small-btn { padding:6px 8px; border-radius:8px; background:rgba(255,255,255,0.04); color:white; border:1px solid rgba(255,255,255,0.06); cursor:pointer; }
    .edit { border-color: #7fffd4; color:#7fffd4; }
    .delete { border-color: #ff9aa2; color:#ff9aa2; }
    .no-data { text-align:center; padding:18px; color:var(--muted); }
    @media (max-width:700px){
      header { flex-direction:column; align-items:flex-start; gap:10px; }
      .controls { width:100%; justify-content:space-between; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ðŸš¨ Rider Absconding Tracker (Realtime)</h1>
      <div class="controls">
        <input id="searchInput" class="search" placeholder="Search Rider Name (case-insensitive)" />
        <button class="btn btn-danger" onclick="clearAll()">Clear All</button>
      </div>
    </header>

    <section>
      <div class="form-grid">
        <input id="riderName" placeholder="Rider Name" />
        <input id="orderId" placeholder="Order ID" />
        <input id="phoneNumber" placeholder="Phone Number" />
        <select id="remarks">
          <option value="Rider Absconded with order">Rider Absconded with order</option>
          <option value="Rider misbehaved with customer">Rider misbehaved with customer</option>
          <option value="Wrong address delivered">Wrong address delivered</option>
          <option value="Other issue">Other issue</option>
        </select>
      </div>

      <div style="display:flex;gap:10px;margin-bottom:12px;">
        <button class="btn btn-primary" onclick="addOrUpdate()">Save Entry</button>
        <button class="btn" onclick="clearForm()" style="background:rgba(255,255,255,0.04);color:#cfeeff">Clear Form</button>
      </div>
    </section>

    <table aria-live="polite">
      <thead>
        <tr>
          <th>Rider Name</th>
          <th>Order ID</th>
          <th>Phone</th>
          <th>Remarks</th>
          <th>Date</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <tr><td colspan="6" class="no-data">Loadingâ€¦</td></tr>
      </tbody>
    </table>
  </div>

  <script type="module">
    // Firebase (modules)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCMcTi-dZnWVgeTFg17rLZwDaHJCM4RF08",
      authDomain: "real-time-502b1.firebaseapp.com",
      projectId: "real-time-502b1",
      storageBucket: "real-time-502b1.firebasestorage.app",
      messagingSenderId: "483376670752",
      appId: "1:483376670752:web:366d8934a004c8372bf445",
      measurementId: "G-NVV0L581GB",
      databaseURL: "https://real-time-502b1-default-rtdb.firebaseio.com/"
    };

    // init
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dataRef = ref(db, "riderAbsconding");

    // in-memory snapshot store for filtering
    let snapshotStore = {}; // { key: entry }
    let editKey = null;

    const tableBody = document.getElementById('tableBody');
    const searchInput = document.getElementById('searchInput');

    // utility to sanitize text for display
    const esc = (s) => (s===undefined||s===null) ? '' : String(s);

    // render function uses snapshotStore and current search filter
    function renderTable() {
      const query = (searchInput.value || '').trim().toLowerCase();
      const keys = Object.keys(snapshotStore).sort((a,b) => {
        // sort by timestamp descending if present, else by key
        const ta = snapshotStore[a]?.timestamp || '';
        const tb = snapshotStore[b]?.timestamp || '';
        return (tb.localeCompare(ta));
      });

      tableBody.innerHTML = '';

      const filtered = keys.filter(k => {
        if (!query) return true;
        const name = (snapshotStore[k].name || '').toLowerCase();
        return name.includes(query);
      });

      if (filtered.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6" class="no-data">No matching records</td></tr>';
        return;
      }

      for (const key of filtered) {
        const e = snapshotStore[key];
        const tr = document.createElement('tr');

        tr.innerHTML = `
          <td>${esc(e.name)}</td>
          <td>${esc(e.orderId)}</td>
          <td>${esc(e.phone)}</td>
          <td>${esc(e.remarks)}</td>
          <td>${esc(e.timestamp)}</td>
          <td class="actions"></td>
        `;

        const actionsTd = tr.querySelector('.actions');

        // Edit button
        const editBtn = document.createElement('button');
        editBtn.className = 'small-btn edit';
        editBtn.textContent = 'Edit';
        editBtn.onclick = () => {
          document.getElementById('riderName').value = e.name || '';
          document.getElementById('orderId').value = e.orderId || '';
          document.getElementById('phoneNumber').value = e.phone || '';
          document.getElementById('remarks').value = e.remarks || '';
          editKey = key;
          editBtn.blur();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        };
        actionsTd.appendChild(editBtn);

        // Delete button
        const delBtn = document.createElement('button');
        delBtn.className = 'small-btn delete';
        delBtn.textContent = 'Delete';
        delBtn.onclick = () => {
          if (confirm('Delete this entry?')) {
            remove(ref(db, `riderAbsconding/${key}`));
          }
        };
        actionsTd.appendChild(delBtn);

        tableBody.appendChild(tr);
      }
    }

    // Realtime listener â€” keep snapshotStore updated
    onValue(dataRef, (snapshot) => {
      snapshotStore = {};
      if (snapshot.exists()) {
        snapshot.forEach(child => {
          snapshotStore[child.key] = child.val();
        });
      }
      renderTable();
    });

    // add or update
    window.addOrUpdate = function() {
      const name = document.getElementById('riderName').value.trim();
      const orderId = document.getElementById('orderId').value.trim();
      const phone = document.getElementById('phoneNumber').value.trim();
      const remarks = document.getElementById('remarks').value;

      if (!name || !orderId || !phone) {
        alert('Please fill Rider Name, Order ID, and Phone.');
        return;
      }

      const entry = {
        name,
        orderId,
        phone,
        remarks,
        timestamp: new Date().toLocaleString()
      };

      if (editKey) {
        // update
        update(ref(db, `riderAbsconding/${editKey}`), entry)
          .then(() => { alert('Entry updated'); editKey = null; clearForm(); })
          .catch(err => alert('Update failed: ' + err));
      } else {
        // add
        push(dataRef, entry)
          .then(() => { clearForm(); })
          .catch(err => alert('Add failed: ' + err));
      }
    };

    // clear input form
    function clearForm() {
      document.getElementById('riderName').value = '';
      document.getElementById('orderId').value = '';
      document.getElementById('phoneNumber').value = '';
      document.getElementById('remarks').selectedIndex = 0;
      editKey = null;
    }
    window.clearForm = clearForm;

    // delete all
    window.clearAll = function() {
      if (confirm('Delete ALL entries? This cannot be undone.')) {
        remove(dataRef);
      }
    };

    // Search live (debounce lightly)
    let searchTimer = null;
    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(renderTable, 150);
    });

    // initial focus on search
    searchInput.placeholder = 'Search Rider Name (type and press ESC to clear)';
    searchInput.addEventListener('keydown', (ev) => {
      if (ev.key === 'Escape') {
        searchInput.value = '';
        renderTable();
      }
    });
  </script>
</body>
</html>
