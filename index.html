<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Rider Absconding Tracker â€” debug-ready</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* minimal styles kept from your working UI */
    body { font-family: Inter, Arial, sans-serif; margin:0; min-height:100vh;
      display:flex;align-items:center;justify-content:center;
      background: linear-gradient(135deg,#1e3c72,#2a5298); color:#fff;
    }
    .container{width:95%;max-width:900px;padding:26px;border-radius:14px;
      background:rgba(255,255,255,0.06);backdrop-filter:blur(8px);box-shadow:0 10px 30px rgba(0,0,0,0.4);
    }
    h2{ text-align:center; margin:0 0 18px; font-size:24px;
      background:linear-gradient(90deg,#00f5d4,#9b5de5); -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    }
    .form{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:14px}
    input, select{padding:10px;border-radius:10px;border:none;background:rgba(255,255,255,0.12); color:#fff}
    .row { display:flex; gap:10px; align-items:center; margin-top:10px; }
    button{padding:10px 14px;border-radius:10px;border:none;cursor:pointer}
    .add-btn{background:linear-gradient(90deg,#00f5d4,#00bbf9); color:#002}
    .export-btn{background:linear-gradient(90deg,#ffd200,#f7971e); color:#000}
    .clear-btn{background:linear-gradient(90deg,#ff6b6b,#ff4b4b)}
    table{width:100%;border-collapse:collapse;margin-top:14px}
    th,td{padding:10px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.06)}
    #status {margin-left:6px; font-size:13px; opacity:0.95}
    .small { font-size:13px; opacity:0.9 }
  </style>
</head>
<body>
  <div class="container">
    <h2>ðŸšš Rider Absconding Details â€” Debug Build</h2>

    <div class="form">
      <input id="riderName" placeholder="Rider Name" />
      <input id="orderId" placeholder="Order ID" />
      <select id="remarks">
        <option>Rider Absconded with the order</option>
        <option>Rider misbehaved with customer</option>
        <option>Wrong address delivered</option>
        <option>Other issue</option>
      </select>
      <input id="phoneNumber" placeholder="Phone Number" />
      <button id="addBtn" class="add-btn" onclick="addEntry()">Add</button>
    </div>

    <div class="row">
      <div style="flex:1">
        <button class="export-btn" onclick="exportToCSV()">Export to CSV</button>
        <button class="clear-btn" onclick="clearAll()">Clear All</button>
      </div>
      <div id="status" class="small">Status: <span id="statusText">Not connected</span></div>
    </div>

    <table>
      <thead>
        <tr><th>Rider Name</th><th>Order ID</th><th>Remarks</th><th>Phone</th><th>Actions</th></tr>
      </thead>
      <tbody id="trackerTable"></tbody>
    </table>
  </div>

  <!-- Use module imports; keep versions consistent -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    // --- CONFIG: make sure this DB URL matches your Realtime DB URL from the Firebase console
    const firebaseConfig = {
      apiKey: "AIzaSyC3de0poQVQ8Sa4SO2P2lVvukgtWkxfHtk",
      authDomain: "rider-absconding.firebaseapp.com",
      // Use the exact databaseURL from your Firebase console (no trailing slash)
      databaseURL: "https://rider-absconding-default-rtdb.firebaseio.com",
      projectId: "rider-absconding",
      storageBucket: "rider-absconding.appspot.com",
      messagingSenderId: "16507000056",
      appId: "1:16507000056:web:88505129b8839e1f53970d",
      measurementId: "G-PP2Y2HW8W1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const entriesRef = ref(db, 'entries'); // path used in DB

    // UI elements
    const statusText = document.getElementById('statusText');
    const addBtn = document.getElementById('addBtn');
    const tableBody = document.getElementById('trackerTable');

    // Helper: show status
    function setStatus(msg, color) {
      statusText.innerText = msg;
      if (color) statusText.style.color = color;
    }

    // Listen for realtime changes and render
    onValue(entriesRef, (snapshot) => {
      tableBody.innerHTML = '';
      if (!snapshot.exists()) {
        setStatus('Connected â€” no entries', '#ffd966');
        return;
      }
      setStatus('Connected', '#90ee90');
      snapshot.forEach(child => {
        const id = child.key;
        const data = child.val();
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(data.name||'')}</td>
          <td>${escapeHtml(data.orderId||'')}</td>
          <td>${escapeHtml(data.remarks||'')}</td>
          <td>${escapeHtml(data.phone||'')}</td>
          <td>
            <button class="action-edit" onclick="editEntry('${id}')">Edit</button>
            <button class="action-del" onclick="deleteEntry('${id}')">Delete</button>
          </td>
        `;
        tableBody.prepend(tr);
      });
    }, (err) => {
      console.error('Realtime DB listener error:', err);
      setStatus('DB listener error â€” see console', '#ff6b6b');
    });

    // Add entry (exposed below as global)
    async function addEntry() {
      const name = document.getElementById('riderName').value.trim();
      const orderId = document.getElementById('orderId').value.trim();
      const remarks = document.getElementById('remarks').value;
      const phone = document.getElementById('phoneNumber').value.trim();

      if (!name || !orderId || !phone) {
        alert('Please fill Rider Name, Order ID and Phone.');
        return;
      }

      try {
        addBtn.disabled = true;
        addBtn.innerText = 'Adding...';
        // push to DB
        await push(entriesRef, { name, orderId, remarks, phone });
        // success
        setStatus('Added entry', '#90ee90');
        // clear fields
        document.getElementById('riderName').value = '';
        document.getElementById('orderId').value = '';
        document.getElementById('phoneNumber').value = '';
      } catch (err) {
        console.error('Error adding entry:', err);
        alert('Error adding entry â€” check console for details.');
        setStatus('Error adding entry â€” see console', '#ff6b6b');
      } finally {
        addBtn.disabled = false;
        addBtn.innerText = 'Add';
      }
    }

    // Delete entry
    async function deleteEntry(id) {
      if (!confirm('Delete this entry?')) return;
      try {
        await remove(ref(db, 'entries/' + id));
        setStatus('Deleted entry', '#ffd966');
      } catch (err) {
        console.error('Delete error:', err);
        alert('Error deleting â€” check console.');
        setStatus('Error deleting â€” see console', '#ff6b6b');
      }
    }

    // Edit: prefill + remove old (you can change to update instead)
    function editEntry(id) {
      const row = document.querySelector(`#trackerTable tr td button[onclick*="${id}"]`);
      // fetch the data from DB snapshot is simpler: just prefill by reading current DOM cells
      // Since we prefixed rows with prepend, find the row by scanning
      // Here we'll read DOM to prefill
      const tr = Array.from(tableBody.children).find(r => r.querySelector(`button[onclick*="${id}"]`));
      if (!tr) return;
      document.getElementById('riderName').value = tr.children[0].innerText;
      document.getElementById('orderId').value = tr.children[1].innerText;
      document.getElementById('remarks').value = tr.children[2].innerText;
      document.getElementById('phoneNumber').value = tr.children[3].innerText;
      // remove old entry so "Add" will create new one (simple approach)
      deleteEntry(id);
      setStatus('Editing â€” modify fields and press Add', '#ffd966');
    }

    // Export CSV
    function exportToCSV() {
      const rows = [['Rider Name','Order ID','Remarks','Phone']];
      Array.from(tableBody.children).forEach(tr => {
        const cols = Array.from(tr.children).slice(0,4).map(td => td.innerText.replace(/"/g,'""'));
        rows.push(cols);
      });
      const csv = rows.map(r => r.map(c => `"${c}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'rider_entries.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    // Clear all
    async function clearAll() {
      if (!confirm('Delete ALL entries from database?')) return;
      try {
        await remove(entriesRef);
        setStatus('All entries removed', '#ffd966');
      } catch (err) {
        console.error('Clear all error:', err);
        alert('Error clearing DB â€” check console.');
      }
    }

    // Small HTML-escape helper for safety
    function escapeHtml(s) {
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    // --- IMPORTANT: expose functions globally so inline onclick= works in a module
    window.addEntry = addEntry;
    window.deleteEntry = deleteEntry;
    window.editEntry = editEntry;
    window.exportToCSV = exportToCSV;
    window.clearAll = clearAll;

    // initial status
    setStatus('Connecting to DB...', '#ffd966');
    console.log('Debug: Firebase module initialized.');

  </script>
</body>
</html>
